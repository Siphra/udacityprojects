define(["jquery","globals","backbone","facebook","js-cookie"],function(n,i,e,t,s){var a=e.Model.extend({isNativeUser:function(){return!0},isFBUser:function(){return!1}}),l=e.Model.extend({isNativeUser:function(){return!1},isFBUser:function(){return!0}});return e.Model.extend({initialize:function(n){s.get("loginType")?this.loginType=s.get("loginType"):this.loginType="anon",this.user=null,this.oneSignInCallback=new Array,this.oneSignInFailCallback=new Array,this.oneAlwaysSignInCallback=new Array,this.persistSignInCallback=new Array,this.persistSignInFailCallback=new Array,this.persistAlwaysSignInCallback=new Array,this.oneSignOutCallback=new Array,this.persistSignOutCallback=new Array,this.onCallbackStatus=!1},addOneSignInCallback:function(n){this.user?n(this.user.toJSON()):this.oneSignInCallback.push(n)},addPersistSignInCallback:function(n){this.user&&n(this.user.toJSON()),this.persistSignInCallback.push(n)},addOneSignInFailCallback:function(n){this.oneSignInFailCallback.push(n)},addPersistSignInFailCallback:function(n){this.persistSignInFailCallback.push(n)},addOneAlwaysSignInCallback:function(n){this.user?n(this.user.toJSON()):this.oneAlwaysSignInCallback.push(n)},addPersistAlwaysSignInCallback:function(n){this.user&&n(this.user.toJSON()),this.persistAlwaysSignInCallback.push(n)},addOneSignOutCallback:function(n){this.oneSignOutCallback.push(n)},addPersistSignOutCallback:function(n){this.persistSignOutCallback.push(n)},onSignIn:function(n){this.onCallbackStatus=!0;for(var i=0;i<this.oneSignInCallback.length;++i)this.oneSignInCallback[i](n);for(var i=0;i<this.persistSignInCallback.length;++i)this.persistSignInCallback[i](n);for(var i=0;i<this.oneAlwaysSignInCallback.length;++i)this.oneAlwaysSignInCallback[i](n);for(var i=0;i<this.persistAlwaysSignInCallback.length;++i)this.persistAlwaysSignInCallback[i](n);this.oneSignInCallback=new Array,this.oneSignInFailCallback=new Array,this.oneAlwaysSignInCallback=new Array,this.onCallbackStatus=!1},onFailedSignIn:function(n){this.onCallbackStatus=!0;for(var i=0;i<this.oneSignInFailCallback.length;++i)this.oneSignInFailCallback[i](n);for(var i=0;i<this.persistSignInFailCallback.length;++i)this.persistSignInFailCallback[i](n);for(var i=0;i<this.oneAlwaysSignInCallback.length;++i)this.oneAlwaysSignInCallback[i](n);for(var i=0;i<this.persistAlwaysSignInCallback.length;++i)this.persistAlwaysSignInCallback[i](n);this.oneSignInFailCallback=new Array,this.onCallbackStatus=!1},onSignOut:function(n){this.onCallbackStatus=!0;for(var i=0;i<this.oneSignOutCallback.length;++i)this.oneSignOutCallback[i](n);for(var i=0;i<this.persistSignOutCallback.length;++i)this.persistSignOutCallback[i](n);this.oneSignOutCallback=new Array,this.onCallbackStatus=!1},onModalClose:function(){this.onCallbackStatus||this.onFailedSignIn()},reloadSignInHelper:function(i){n.ajax({url:"/api/private/v1.0/user/login",async:!0,cache:!1,method:"POST",xhrFields:{withCredentials:!0},data:i}).done(function(n){n=JSON.parse(n),n.hasOwnProperty("error")||0==n.length?(this.user=null,this.onFailedSignIn(n)):("FBK"==s.get("loginPlatform")?(this.user=new l(n),t.api("/me?fields=first_name,id,birthday,email,gender,last_name,link,locale,name,timezone,updated_time,verified","get",function(n){"Krux"in window&&Krux("page:load",function(n){n&&console.log("Krux error="+n)},{pageView:!1})}.bind(this))):this.user=new a(n),this.onSignIn(n))}.bind(this))},reloadSignIn:function(){s.get("auth_token")&&s.get("auth_user")?"FBK"===s.get("loginPlatform")?t.getLoginStatus(function(n){"connected"==n.status&&this.reloadSignInHelper({fb_id:n.authResponse.userID,fb_access_token:n.authResponse.expiresIn,token_expires:n.authResponse.expiresIn})}.bind(this)):this.user?this.reloadSignInHelper({auth_token:this.user.get("auth_token"),auth_user:this.user.get("flixsterId"),loginPlatformCode:this.user.get("loginPlatformCode")}):this.reloadSignInHelper():this.onFailedSignIn()},registerNative:function(i,e,t,s){n.ajax({url:"/api/private/v1.0/user/register",async:!0,cache:!1,method:"POST",data:{register_email:t,register_password:s,register_first_name:encodeURIComponent(i),register_last_name:encodeURIComponent(e)}}).done(function(n){n=JSON.parse(n),n.hasOwnProperty("errorMessage")||0==n.length?(this.user=null,this.onFailedSignIn(n)):(this.user=new a(n),this.sendToResponsys(t,i,e),this.onSignIn(n))}.bind(this))},signInNative:function(i,e){n.ajax({url:"/api/private/v1.0/user/login",async:!0,cache:!1,method:"POST",data:{login_username:i,login_password:e}}).done(function(n){n=JSON.parse(n),n.hasOwnProperty("errorMessage")||0==n.length?(this.user=null,this.onFailedSignIn(n)):(this.user=new a(n),this.onSignIn(n))}.bind(this))},onFBLogin:function(i){n.ajax({url:"/api/private/v1.0/user/login",async:!0,cache:!1,method:"POST",xhrFields:{withCredentials:!0},data:{fb_id:i.userID,fb_access_token:i.accessToken,token_expires:i.expiresIn}}).done(function(n){n=JSON.parse(n),n.hasOwnProperty("error")||0==n.length?(this.user=null,this.onFailedSignIn(n)):(this.user=new l(n),this.onSignIn(n))}.bind(this))},signInFacebook:function(){i.fb_ready.done(function(){t.login(function(n){n.authResponse?this.onFBLogin(n.authResponse):(console.log("User cancelled Facebook login or did not fully authorize."),this.onFailedSignIn(n))}.bind(this),{scope:"email,publish_actions,user_friends"})}.bind(this))},onSignOutCallback:function(i){n.post("/api/private/v1.0/user/logout"),this.user=null,this.onSignOut(i)},signOut:function(){if(null==this.user)return void this.onSignOutCallback();dataLayer.push({event:"Header",action:"Logout"}),this.user.isFBUser()?t.getLoginStatus(function(n){"connected"==n.status?t.logout(function(n){this.onSignOutCallback(n)}.bind(this)):this.onSignOutCallback(n)}.bind(this)):this.onSignOutCallback(),this.loginType="anon"},sendToResponsys:function(i,e,t){n.ajax({url:"/api/private/v2.0/responsys/create",async:!0,method:"POST",data:{email:i,firstName:e,lastName:t}})},getAuthStatus:function(){return null!=this.user?this.user.get("loginPlatformCode"):"anon"},isLoggedIn:function(){return null!=this.user&&this.user.get("debugInfo")}})});
//# sourceMappingURL=LoginModel.min.js.map